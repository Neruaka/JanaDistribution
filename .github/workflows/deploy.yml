# ============================================================================
# Deployment Pipeline - Jana Distribution
# ============================================================================
# Ce workflow dÃ©ploie l'application aprÃ¨s validation CI
# S'exÃ©cute uniquement sur push vers main
# ============================================================================

name: ðŸš€ Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  NODE_VERSION: '20'

jobs:
  # ============================================================================
  # JOB 1: VÃ©rification prÃ©-dÃ©ploiement
  # ============================================================================
  pre-deploy-check:
    name: âœ… Pre-Deploy Checks
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: ðŸ” Check for deployable changes
        id: check
        run: |
          # VÃ©rifier si des fichiers importants ont changÃ©
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          
          if echo "$CHANGED_FILES" | grep -qE '^(backend|frontend)/'; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "âœ… Deployable changes detected"
          else
            echo "should_deploy=false" >> $GITHUB_OUTPUT
            echo "â­ï¸ No deployable changes"
          fi

  # ============================================================================
  # JOB 2: DÃ©ploiement Staging
  # ============================================================================
  deploy-staging:
    name: ðŸŽ­ Deploy to Staging
    runs-on: ubuntu-latest
    needs: pre-deploy-check
    if: needs.pre-deploy-check.outputs.should_deploy == 'true' || github.event_name == 'workflow_dispatch'
    environment:
      name: staging
      url: https://staging.jana-distribution.fr

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: ./frontend/dist
        continue-on-error: true

      - name: ðŸš€ Deploy to Staging
        run: |
          echo "## ðŸŽ­ Staging Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Deploying to staging environment..." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # ============================================
          # INSTRUCTIONS DE DÃ‰PLOIEMENT
          # ============================================
          # Remplacez cette section par vos commandes de dÃ©ploiement
          # Exemples :
          #
          # Option 1: SSH vers le serveur
          # ssh user@staging.server 'cd /app && docker compose pull && docker compose up -d'
          #
          # Option 2: Kubernetes
          # kubectl apply -f k8s/staging/
          #
          # Option 3: Cloud Provider (AWS ECS, Google Cloud Run, etc.)
          # aws ecs update-service --cluster staging --service jana --force-new-deployment
          # ============================================
          
          echo "âœ… Staging deployment completed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** https://staging.jana-distribution.fr" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ§ª Run smoke tests
        run: |
          echo "Running smoke tests on staging..."
          # Ajouter vos tests de smoke ici
          # curl -f https://staging.jana-distribution.fr/api/health || exit 1
          echo "âœ… Smoke tests passed!"

  # ============================================================================
  # JOB 3: DÃ©ploiement Production (manuel)
  # ============================================================================
  deploy-production:
    name: ðŸŒ Deploy to Production
    runs-on: ubuntu-latest
    needs: deploy-staging
    if: github.event.inputs.environment == 'production'
    environment:
      name: production
      url: https://jana-distribution.fr

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸš€ Deploy to Production
        run: |
          echo "## ðŸŒ Production Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Deploying to production environment..." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # MÃªmes instructions que staging, adaptÃ©es pour la production
          
          echo "âœ… Production deployment completed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** https://jana-distribution.fr" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ“¢ Notify deployment
        run: |
          echo "Sending deployment notification..."
          # Ajouter notifications (Slack, Discord, email, etc.)

  # ============================================================================
  # JOB 4: RÃ©sumÃ© du dÃ©ploiement
  # ============================================================================
  deployment-summary:
    name: ðŸ“Š Deployment Summary
    runs-on: ubuntu-latest
    needs: [deploy-staging, deploy-production]
    if: always()

    steps:
      - name: ðŸ“‹ Generate Summary
        run: |
          echo "# ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | Status | URL |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------|--------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| Staging | ${{ needs.deploy-staging.result == 'success' && 'âœ… Deployed' || needs.deploy-staging.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} | https://staging.jana-distribution.fr |" >> $GITHUB_STEP_SUMMARY
          echo "| Production | ${{ needs.deploy-production.result == 'success' && 'âœ… Deployed' || needs.deploy-production.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} | https://jana-distribution.fr |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Deployed by: @${{ github.actor }}*" >> $GITHUB_STEP_SUMMARY
          echo "*Commit: ${{ github.sha }}*" >> $GITHUB_STEP_SUMMARY
          echo "*Date: $(date)*" >> $GITHUB_STEP_SUMMARY
